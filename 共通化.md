## 目的
- 複数の note アカウント／ジャンルで同種の自動処理を運用するにあたり、共通部分を一元化し、各アカウント側は最小限の差分設定のみで維持・拡張できるようにする。
- 既存のローカル実行コマンド（例: `node likeUnlikedNotes.js --bg` 等）の挙動・引数・ログを変更せずに移行する。
- GitHub Actions の無料枠を活用しつつ、Docker を使わない前提でも運用可能とする。

## 全体方針（コード共通化 × 設定差分）
- 共有リポジトリ（public）を 1 つ用意し、そこに共通ロジック・テンプレート・デフォルト設定を集約する。
- 各アカウント側リポジトリでは、基本的に「設定ファイル＋薄い実行スクリプト（ラッパー）」のみを持ち、実装は共有ライブラリを利用する。
- アカウント差分（例: プロンプト、投稿時間帯、タグ、レート設定など）は設定ファイル（YAML/JSON）で表現し、優先度（デフォルト → ジャンル共通 → アカウント固有）で上書きする設定駆動にする。

## リポジトリ構成（最小）
- 共有リポ（public）: `note-automation-core`
  - 共通ライブラリ（npm 公開; Node/TS）
  - デフォルト設定（例: `configs/defaults/*.yaml`）
  - （任意）再利用可能 Workflow / Composite Action（Docker 不要）
- 各アカウント側リポ: `note-automation-<genre-or-account>`
  - アカウント固有設定（`config/account.yaml` や `config/prompts/*.yaml`）
  - 既存スクリプト名のままの薄いラッパー（内部で共有ライブラリを呼ぶ）

## 導入・インストール（Docker なし）
- 共有リポを npm に public 発行: `@owner/note-automation-core`
- 各アカウント側でインストール:
  - `npm install @owner/note-automation-core`
- 既存スクリプトはそのまま残し、中身で共有ライブラリを呼ぶようにする（ストラングラーパターン）。

## ローカル実行の維持
- 既存の実行例はそのまま利用可能:
  - `node likeUnlikedNotes.js --bg`
  - `node autoPublishNotes.js --bg`
  - `node follow/followFromArticles.js --bg`
  - `node likeNotesByUrl.js --bg https://note.com/...`
- 代替として、コア側に CLI を `bin` で提供し、`npx note-core <cmd>` も併用可能（任意; 既存コマンドは継続）。

## 設定駆動（差分表現）
- 設定例: `config/account.yaml`
  - `genre`, `locale`, `posting`（曜日・時間帯）, `ai`（モデル・温度・テンプレ）, `note`（認証方法）, `sheets`（連携有無） など。
- プロンプトはテンプレート化（Mustache/Jinja 風）し、`{{genre}}`, `{{seasonal_topic}}` 等の変数でアカウント差分を吸収。
- 優先度: 共通デフォルト → ジャンル共通 → アカウント固有。未指定はデフォルトを採用。

## バージョニング・更新
- 共有ライブラリは SemVer 準拠。
  - 破壊的変更はメジャー更新（例: v1 → v2）。
  - 各アカウント側は `^1.x` の範囲で追随。
- Renovate/Dependabot による自動アップデート PR（任意; 推奨）。

## GitHub Actions（任意・将来拡張）
- Docker 不要で運用可能。`actions/setup-node` + `npm ci` + 共有ライブラリ呼び出し。
- スケジュールは各アカウント側で設定（分単位でずらし、負荷・レート分散）。
- Secrets（Cookie, API Key など）は各アカウント側リポに保持。

### 定期実行頻度の調整
- **設定ファイルでの頻度制御**: `config/schedule.yaml`で各スクリプトの実行頻度を個別設定
- **アカウント別の実行パターン**: 
  - 毎日実行（`daily`）
  - 平日のみ（`weekdays`）
  - 週1回（`weekly`）
  - 月1回（`monthly`）
  - カスタムcron式（`custom`）
- **負荷分散**: 各アカウントで実行時刻を分単位でずらし、API制限を回避
- **実行時間帯の制御**: 営業時間内のみ実行、深夜時間帯の実行など

### 設定例
```yaml
# config/schedule.yaml
scripts:
  likeUnlikedNotes:
    frequency: daily
    time_offset: 0  # 0分オフセット
  autoPublishNotes:
    frequency: weekdays
    time_offset: 5  # 5分オフセット
  followFromArticles:
    frequency: weekly
    time_offset: 10
  likeNotesByUrl:
    frequency: daily
    time_offset: 15
    urls:
      - "https://note.com/counselor_risa"
      - "https://note.com/investment_happy"
      - "https://note.com/enginner_skill"
```

### OpenRouter API制限の回避
- **複数アカウントの活用**: OpenRouterのAPI制限はアカウント単位で適用されるため、複数アカウントを作成することで制限を分散可能
- **RPS（Requests Per Second）の向上**: アカウント残高に応じてRPSが増加（1ドル未満でも最小1RPS、500ドル以上で最大500RPS）
- **アカウント別のAPIキー管理**: 各noteアカウント用リポジトリで異なるOpenRouter APIキーを使用
- **負荷分散**: 各アカウントで異なるAPIキーを使用し、同時実行時の制限を回避
- **設定例**:
  ```yaml
  # config/account.yaml
  ai:
    provider: openrouter
    api_key_secret_name: OPENROUTER_API_KEY_ACCOUNT_1
    model: gpt-4o-mini
    temperature: 0.7
  ```

## 前準備（共通化前の整理）
### 1. 不要なものの削除
- 使用されていないファイル・ディレクトリの特定と削除
- 不要な依存関係（`package.json`の`dependencies`）の削除
- 古い設定ファイルやテストファイルの整理
- 重複する機能の統合

### 2. CommonJS → ESモジュール対応
- `package.json`に`"type": "module"`を追加
- `require()` → `import`文への変換
- `module.exports` → `export`文への変換
- `__dirname`, `__filename`の代替手段実装（`import.meta.url`使用）
- 動的`require()`の対応（`import()`使用）

### 3. 動作確認
- 各スクリプトの個別実行テスト
- 既存の実行コマンドでの動作確認
- エラーハンドリングの確認
- ログ出力の確認

## 段階移行のガイド（処理を一切変えずに共通化）
1. 現行スクリプトの入出力と引数仕様を一覧化（ドキュメント化）。
2. 共有ライブラリ側に、現行仕様と互換の API を用意。
3. 各スクリプトの内部実装のみを共有ライブラリ呼び出しに差し替え（関数名・引数・戻り値・ログは不変）。
4. アカウント固有の値を `config/account.yaml` 等へ切り出し（既存の直書きがあれば読み替え）。
5. 最初は 1 スクリプトだけ移行 → 動作確認 → 残りを順次移行。

## 将来拡張
- CLI（`bin`）での一括起動・個別起動の両立。
- 再利用 Workflow / Composite Action 化（必要になった時点で導入）。
- ログ収集・失敗時のリトライ／指数バックオフを共有ライブラリで統一。

## 付録：最小コード例（薄いラッパー化のイメージ）
```javascript
// likeNotesByUrl.js
// 日本語コメント: 既存のCLI引数・動作は維持しつつ、実装は共有ライブラリに委譲します。
#!/usr/bin/env node
const { runLikeNotesByUrl } = require('@owner/note-automation-core');
const url = process.argv[process.argv.length - 1];
const bg = process.argv.includes('--bg');
runLikeNotesByUrl({ url, background: bg, accountConfigPath: 'config/account.yaml' })
  .catch(e => { console.error(e); process.exit(1); });
```

```yaml
# config/account.yaml（例）
genre: tech
locale: ja-JP
posting:
  time_window: ["09:00", "11:00"]
  days: [Mon, Tue, Wed, Thu, Fri]
ai:
  model: gpt-4o-mini
  temperature: 0.7
  prompt_template: prompts/daily.yaml
note:
  login_method: cookie
  cookie_secret_name: NOTE_COOKIE
sheets:
  enabled: true
  doc_id: "xxxxx"
  worksheet: "posts"
overrides:
  seasonal_topic: "生成AI最新動向"
```
