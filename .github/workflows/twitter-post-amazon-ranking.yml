name: Twitter Post Amazon Ranking

on:
  schedule:
    - cron: '0 */3 * * *'  # 3時間おき（UTC）
  workflow_dispatch:
    inputs:
      dryrun:
        description: 'Dryrun (true の場合は投稿しない)'
        required: false
        default: 'false'

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Checkout core (note-auto-core)
        uses: actions/checkout@v4
        with:
          repository: aa-0921/note-auto-core
          path: core

      - name: Build local core package
        run: |
          cd core
          npm ci
          npm pack
          ls -l *.tgz

      - name: Install dependencies (renai)
        run: |
          npm ci
          npm i ./core/*.tgz

      - name: Run script (schedule -> production)
        if: ${{ github.event_name == 'schedule' }}
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          node scripts/twitterPostAmazonRanking.js

      - name: Run script (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          if [ "${{ github.event.inputs.dryrun }}" = "true" ]; then
            echo "Run in dryrun mode"
            node scripts/twitterPostAmazonRanking.js --dryrun
          else
            node scripts/twitterPostAmazonRanking.js
          fi


